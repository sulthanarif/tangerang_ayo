<!DOCTYPE html>
<html>
  <head>
    <title>Bus Animation with Leaflet and OpenStreetMap</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"
    />
    <link
      rel="stylesheet"
      href="Leaflet.Coordinates/dist/Leaflet.Coordinates-0.1.5.css"
    />
    <link
      rel="stylesheet"
      href="Leaflet.Coordinates/dist/Leaflet.Coordinates-0.1.5.ie.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-responsive-popup@1.0.0/leaflet.responsive.popup.css"
    />
    <script src="https://unpkg.com/leaflet-responsive-popup@1.0.0/leaflet.responsive.popup.js"></script>
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script src="Leaflet.Coordinates/dist/Leaflet.Coordinates-0.1.5.min.js"></script>
  </head>

  <body>
    <div id="map" style="height: 100vh"></div>

    <script>
      var map = L.map("map").setView([-6.2074836, 106.6037775], 13);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      L.control
        .coordinates({
          position: "bottomleft",
          useDMS: true,
          decimal: 8,
          decimalSeperator: ",",
          labelTemplateLat: "Latitude: {y}",
          labelTemplateLng: "Longitude: {x}",
        })
        .addTo(map);

      // Simulated Bus
      var busIcons = {
        "koridor-1": L.icon({
          iconUrl: "img/koridor-1.svg",
          iconSize: [16, 16],
          iconAnchor: [12, 6],
          popupAnchor: [10, 2],
        }),
        "koridor-2": L.icon({
          iconUrl: "img/koridor-2.svg",
          iconSize: [16, 16],
          iconAnchor: [8, 6],
          popupAnchor: [10, 2],
        }),
      };

      var markerIcons = {
        "koridor-1": L.icon({
          iconUrl: "img/halte-koridor-1.svg",
          iconSize: [16, 16],
          iconAnchor: [12, 16],
          popupAnchor: [-6, -12],
        }),
        "koridor-2": L.icon({
          iconUrl: "img/halte-koridor-2.svg",
          iconSize: [16, 16],
          iconAnchor: [12, 16],
          popupAnchor: [-6, -12],
        }),
      };

      var marker = {
        "koridor-1": L.marker([-6.175304905620621, 106.64647013286424], {
          icon: markerIcons["koridor-1"],
        })
          .addTo(map)
          .bindPopup("jatake"),
        "koridor-2": L.marker([-6.1753744, 106.6447591], {
          icon: markerIcons["koridor-2"],
        })
          .addTo(map)
          .bindPopup("Tanah Tinggi"),
      };

      //bus marker
      var busMarker = {
        "koridor-1": L.marker([-6.2002793, 106.5740835], {
          icon: busIcons["koridor-1"],
        }).addTo(map),
        "koridor-2": L.marker([-6.1753744, 106.6447591], {
          icon: busIcons["koridor-2"],
        }).addTo(map),
      };

      class Busses {
        constructor(code,plat,corridor, lat, lng) {
          this.code = code;
          this.plat = plat;
          this.corridor = corridor;
          this.speed = 0;
          this.nextStop = "";
          this.distanceToBusStop = 0;
          this.position = L.latLng(lat, lng);
        }
      }




      class BusStop {
        constructor(name, lat, lng) {
          this.name = name;
          this.corridor = [];
          this.position = L.latLng(lat, lng);
          this.nextStop = "";
          this.distanceToNextStop = 0; // Tambahkan properti untuk jarak
          this.estimatedArrivalTime = ""; // Tambahkan properti untuk estimasi waktu
        }
      }

      class Corridor {
        constructor(name) {
          this.name = name;
          this.busStops = {};
          this.busStopMarkers = {};
        }

        async addBusStop(busStop, targetBusStop) {
  this.busStops[busStop.name] = busStop;
  this.busStopMarkers[busStop.name] = L.marker(busStop.position, {
    icon: markerIcons[this.name],
  }).addTo(map).bindPopup(busStop.name); // Menambahkan marker ke peta

  if (targetBusStop) {
    const currentStopLatLng = `${busStop.position.lng},${busStop.position.lat}`;
    const nextStopLatLng = `${targetBusStop.position.lng},${targetBusStop.position.lat}`;
    try {
      const response = await fetch(
        `http://router.project-osrm.org/route/v1/driving/${currentStopLatLng};${nextStopLatLng}?overview=false`
      );
      if (!response.ok) {
        throw new Error('Failed to fetch route data');
      }
      const routeData = await response.json();
      const speed = 10;
      busStop.nextStop = targetBusStop.name;
      busStop.distanceToNextStop = routeData.routes[0].distance;
      busStop.estimatedArrivalTime = formatTime(routeData.routes[0].distance / speed);
    } catch (error) {
      console.error('Error fetching route data:', error);
      // Handle error (e.g., set default values for distance and arrival time)
    }
  }
}



        getBusStop(name) {
          return this.busStops[name];
        }

        getAllBusStops() {
          return Object.values(this.busStops);
        }

      }

      function createRoutingControl(corridors, busMarker, map) {
        const corridorColors = {
          "koridor-1": "blue",
          "koridor-2": "yellow",
        };
        return corridors.map((corridor) => {
          const busStops = corridor.getAllBusStops();
          const waypoints = busStops.map((busStop) => busStop.position);
          waypoints.push(busStops[0].position); // Kembali ke titik awal
          const lineColor = corridorColors[corridor.name];

          return L.Routing.control({
            waypoints: waypoints,
            routeWhileDragging: false,
            show: false,
            lineOptions: {
              styles: [
                {
                  color: lineColor,
                  opacity: 1,
                  weight: 3,
                },
              ],
            },
            createMarker: function () {
              return null;
            },
          })
            .on("routesfound", function (e) {
              var route = e.routes[0];
              var coordinates = route.coordinates;

              var summary = e.routes[0].summary;
              console.log(summary);
              moveBus(busMarker[corridor.name], coordinates);
            })
            .addTo(map);
        });

        // marker.on("click", function (e) {
        //   const busStop = e.target.options.busStop;
        //   // Assuming you've stored the BusStop object in the marker options
        //   const popupContent = `<b>${
        //     busStop.name
        //   }</b><br>Jarak ke halte berikutnya: ${busStop.distanceToNextStop.toFixed(
        //     0
        //   )} meter<br>Estimasi waktu kedatangan: ${
        //     busStop.estimatedArrivalTime
        //   }`;
        //   L.popup()
        //     .setContent(popupContent)
        //     .setLatLng(busStop.position)
        //     .openOn(map);
        // });
        // corridors.forEach((corridor) => {
        //   // ...
        //   corridor.calculateDistancesAndETA(10); // Contoh: kecepatan rata-rata 20 m/s
        //   // ...
        // });
      }

      // Membuat instance dari kelas BusStop
      const jatake = new BusStop("Jatake", -6.2002793, 106.5740835);
      const lembagaSosial = new BusStop(
        "Lembaga Sosial",
        -6.1662847,
        106.6468223
      );
      const tanahTinggi = new BusStop("Stasiun Tanah Tinggi",-6.175304905620621,106.64647013286424);
      const porisPlawad = new BusStop("Poris Plawad",-6.173535208406348,106.66384935389944);
      const imigrasi = new BusStop("Imigrasi", -6.1705643, 106.6438538);
      const smpNegeri5Tangerang = new BusStop("SMP Negeri 5 Tangerang",-6.1673159,106.641795);
      const tamanPisang = new BusStop("Taman Pisang", -6.210759, 106.6147218);
      const sawo = new BusStop("Sawo", -6.2140173, 106.6093523);
      const borobudur = new BusStop("Borobudur", -6.2146956, 106.6018589);
      const alunAlunPam = new BusStop("Alun-Alun PAM Cibodas",-6.2071704,106.605293);
      const smpn6Tangerang = new BusStop("SMP Negeri 6 Tangerang",-6.2074886,106.6132225);
      const terminalCimone = new BusStop("Terminal Cimone",-6.186198256476928,106.61542744880222);
      // Membuat instance dari kelas Corridor
      const corridor1 = new Corridor("koridor-1");
      const corridor2 = new Corridor("koridor-2");

      // Menambahkan BusStop ke Corridor
      corridor1.addBusStop(jatake, lembagaSosial);
      corridor1.addBusStop(lembagaSosial, tanahTinggi);
      corridor1.addBusStop(tanahTinggi, porisPlawad);
      corridor1.addBusStop(porisPlawad, imigrasi);
      corridor1.addBusStop(imigrasi, smpNegeri5Tangerang);
      corridor1.addBusStop(smpNegeri5Tangerang, terminalCimone);
      corridor1.addBusStop(terminalCimone, jatake);

      corridor2.addBusStop(porisPlawad);
      corridor2.addBusStop(tamanPisang);
      corridor2.addBusStop(sawo);
      corridor2.addBusStop(borobudur);
      corridor2.addBusStop(alunAlunPam);
      corridor2.addBusStop(smpn6Tangerang);
      corridor2.addBusStop(tanahTinggi);

      // Membuat array dari Corridor
      const corridors = [corridor1, corridor2];
      // tambahkan Corridor lainnya ke array di sini
      console.log(corridors);
      // Membuat Routing Control untuk setiap Corridor
      const routingControls = createRoutingControl(corridors, busMarker, map);

      function moveBus(busMarker, coordinates) {
        var index = 0;

        function animate() {
          busMarker.setLatLng(coordinates[index]);
          index = (index + 1) % coordinates.length; // Loop ke titik awal setelah mencapai titik terakhir
          setTimeout(animate, 5000); // Mengatur kecepatan pergerakan bus
        }

        animate();
      }

      function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const remainingSeconds = Math.ceil(seconds % 60);
        return `${hours} jam ${minutes} menit ${remainingSeconds} detik`;
      }
    </script>
  </body>
</html>
